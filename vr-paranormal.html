<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paranormal VR Experience</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
        body { margin: 0; }
        #instructions {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div id="instructions">
        Put on your Meta Quest 3 and click "Enter VR" for full paranormal vision
    </div>
    
    <a-scene vr-mode-ui="enabled: true"
             webxr="optionalFeatures: dom-overlay,dom-overlay-for-handheld-ar,hit-test,local-floor,bounded-floor,hand-tracking,layers;
                     requiredFeatures: local-floor,hit-test;
                     overlayElement: #overlay">
        
        <!-- Custom shader for negative vision effect -->
        <a-assets>
            <script id="negative-shader" type="x-shader/x-fragment">
                precision mediump float;
                varying vec2 vUv;
                uniform sampler2D map;
                
                void main() {
                    vec4 texel = texture2D(map, vUv);
                    // Invert colors and add green tint for paranormal effect
                    vec3 negative = vec3(1.0 - texel.r, 1.0 - texel.g + 0.2, 1.0 - texel.b);
                    gl_FragColor = vec4(negative, 1.0);
                }
            </script>
        </a-assets>

        <!-- Passthrough setup -->
        <a-entity id="rig" position="0 1.6 0">
            <a-camera id="camera" look-controls wasd-controls="enabled: false">
                <a-entity id="passthrough"
                          geometry="primitive: plane; width: 4; height: 4;"
                          position="0 0 -0.01"
                          material="shader: flat; transparent: true; opacity: 0.9"
                          visible="false">
                </a-entity>
            </a-camera>
        </a-entity>

        <!-- Environment (will be replaced by passthrough) -->
        <a-sky color="#000" opacity="0.1"></a-sky>
    </a-scene>

    <script>
        // WebXR setup for passthrough
        const scene = document.querySelector('a-scene');
        const camera = document.querySelector('#camera');
        
        if (navigator.xr) {
            navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
                if (supported) {
                    setupPassthrough();
                }
            });
        }

        function setupPassthrough() {
            // Set up passthrough when entering VR
            scene.addEventListener('enter-vr', function () {
                if (scene.is('vr-mode')) {
                    // Request camera stream for Quest passthrough
                    navigator.mediaDevices.getUserMedia({ 
                        video: {
                            facingMode: 'environment',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        } 
                    }).then(stream => {
                        const video = document.createElement('video');
                        video.srcObject = stream;
                        video.play();

                        // Create canvas for processing
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = 1920;
                        canvas.height = 1080;

                        // Process frames with negative effect
                        function processFrame() {
                            ctx.drawImage(video, 0, 0);
                            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                            const data = imageData.data;

                            for (let i = 0; i < data.length; i += 4) {
                                // Invert colors
                                data[i] = 255 - data[i];         // Red
                                data[i + 1] = 255 - data[i + 1]; // Green
                                data[i + 2] = 255 - data[i + 2]; // Blue
                                
                                // Add paranormal green tint
                                data[i + 1] = Math.min(255, data[i + 1] + 50);
                            }

                            ctx.putImageData(imageData, 0, 0);
                            
                            // Update passthrough texture
                            const passthrough = document.querySelector('#passthrough');
                            passthrough.setAttribute('material', {
                                src: canvas.toDataURL('image/webp'),
                                shader: 'flat',
                                transparent: true,
                                opacity: 0.95
                            });
                            passthrough.setAttribute('visible', true);

                            requestAnimationFrame(processFrame);
                        }

                        processFrame();
                    }).catch(console.error);
                }
            });
        }

        // Handle VR session end
        scene.addEventListener('exit-vr', function () {
            const passthrough = document.querySelector('#passthrough');
            if (passthrough) {
                passthrough.setAttribute('visible', false);
            }
        });
    </script>
</body>
</html> 